/*
 * Generated by the Jasper component of Apache Tomcat
 * Version: JspC/ApacheTomcat8
 * Generated at: 2023-01-06 09:59:01 UTC
 * Note: The last modified time of this file was set to
 *       the last modified time of the source file after
 *       generation to assist with modification tracking.
 */
package org.apache.jsp.weixin.workflow;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;
import com.js.oa.weixin.common.util.WorkflowForWeiXinUtil;
import com.js.util.util.DataSourceBase;
import java.util.Random;
import com.js.lang.Resource;
import com.js.util.config.SystemCommon;
import com.js.util.util.BrowserJudge;
import java.util.*;

public final class workflow_005finclude_005fmiddleHiddenForWeiXin_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent,
                 org.apache.jasper.runtime.JspSourceImports {

  private static final javax.servlet.jsp.JspFactory _jspxFactory =
          javax.servlet.jsp.JspFactory.getDefaultFactory();

  private static java.util.Map<java.lang.String,java.lang.Long> _jspx_dependants;

  private static final java.util.Set<java.lang.String> _jspx_imports_packages;

  private static final java.util.Set<java.lang.String> _jspx_imports_classes;

  static {
    _jspx_imports_packages = new java.util.HashSet<>();
    _jspx_imports_packages.add("javax.servlet");
    _jspx_imports_packages.add("java.util");
    _jspx_imports_packages.add("javax.servlet.http");
    _jspx_imports_packages.add("javax.servlet.jsp");
    _jspx_imports_classes = new java.util.HashSet<>();
    _jspx_imports_classes.add("com.js.oa.weixin.common.util.WorkflowForWeiXinUtil");
    _jspx_imports_classes.add("com.js.lang.Resource");
    _jspx_imports_classes.add("com.js.util.config.SystemCommon");
    _jspx_imports_classes.add("com.js.util.util.DataSourceBase");
    _jspx_imports_classes.add("java.util.Random");
    _jspx_imports_classes.add("com.js.util.util.BrowserJudge");
  }

  private volatile javax.el.ExpressionFactory _el_expressionfactory;
  private volatile org.apache.tomcat.InstanceManager _jsp_instancemanager;

  public java.util.Map<java.lang.String,java.lang.Long> getDependants() {
    return _jspx_dependants;
  }

  public java.util.Set<java.lang.String> getPackageImports() {
    return _jspx_imports_packages;
  }

  public java.util.Set<java.lang.String> getClassImports() {
    return _jspx_imports_classes;
  }

  public javax.el.ExpressionFactory _jsp_getExpressionFactory() {
    if (_el_expressionfactory == null) {
      synchronized (this) {
        if (_el_expressionfactory == null) {
          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();
        }
      }
    }
    return _el_expressionfactory;
  }

  public org.apache.tomcat.InstanceManager _jsp_getInstanceManager() {
    if (_jsp_instancemanager == null) {
      synchronized (this) {
        if (_jsp_instancemanager == null) {
          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());
        }
      }
    }
    return _jsp_instancemanager;
  }

  public void _jspInit() {
  }

  public void _jspDestroy() {
  }

  public void _jspService(final javax.servlet.http.HttpServletRequest request, final javax.servlet.http.HttpServletResponse response)
      throws java.io.IOException, javax.servlet.ServletException {

    final java.lang.String _jspx_method = request.getMethod();
    if (!"GET".equals(_jspx_method) && !"POST".equals(_jspx_method) && !"HEAD".equals(_jspx_method) && !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) {
      response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, "JSPs only permit GET, POST or HEAD. Jasper also permits OPTIONS");
      return;
    }

    final javax.servlet.jsp.PageContext pageContext;
    javax.servlet.http.HttpSession session = null;
    final javax.servlet.ServletContext application;
    final javax.servlet.ServletConfig config;
    javax.servlet.jsp.JspWriter out = null;
    final java.lang.Object page = this;
    javax.servlet.jsp.JspWriter _jspx_out = null;
    javax.servlet.jsp.PageContext _jspx_page_context = null;


    try {
      response.setContentType("text/html; charset=utf-8");
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write("\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n");

request.setCharacterEncoding("utf-8");
String localhi = session.getAttribute("org.apache.struts.action.LOCALE").toString();

String pageKey=String.valueOf(new java.util.Date().getTime());
//workVO
String workId = WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("work")));
String processId = WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("processId")));
String tableId = WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("table")));
String recordId = WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("record")));
String stepCount = WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("stepCount")));
String hangup = (String)request.getAttribute("hangup");
String workType = WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("workType")));
int inWorkType = ("null".equals(workType) || workType==null)?-1:Integer.parseInt(workType);//流程类型 0随机流程,1业务流程
String curTransactType = new com.js.oa.jsflow.service.WorkFlowButtonBD().getCurTransactTypeByWorkId(workId);//当前节点办理方式
//判断是否已经发起子流程
String subProcWorkId=new com.js.oa.jsflow.service.WorkFlowButtonBD().getSubProcWorkId(processId,tableId,recordId);
if(subProcWorkId==null){
	subProcWorkId="";
}

com.js.oa.jsflow.vo.WorkVO workVO = new com.js.oa.jsflow.vo.WorkVO();
if(workId!=null && tableId!=null && recordId!=null){
	workVO.setId(Long.valueOf(workId));
	workVO.setTableId(Long.valueOf(tableId));
	workVO.setRecordId(Long.valueOf(recordId));
	workVO.setStepCount(stepCount);
}

int inWorkStatus = new com.js.oa.jsflow.service.WorkFlowBD().getWorkStatusByWorkId(workId);
String curParallelActId=request.getAttribute("workPrarllelCurActId")==null?"0":request.getAttribute("workPrarllelCurActId").toString();


      out.write("\r\n<script type='text/javascript' src='/jsoa/workflow/dwr/interface/workflowSync.js'></script>\r\n<script type='text/javascript' src='/jsoa/workflow/dwr/engine.js'></script>\r\n\r\n<link href=\"/jsoa/skin/");
      out.print(session.getAttribute("skin"));
      out.write("/style-");
      out.print(session.getAttribute("browserVersion"));
      out.write("-doc.css\" rel=\"stylesheet\" type=\"text/css\" />\r\n<input type=\"hidden\" name=\"workId\" id=\"workId\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("work"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"tableId\" id=\"tableId\" value=\"");
      out.print((tableId!=null && !tableId.toUpperCase().equals("NULL")&& tableId.length()>0) ? tableId : WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getAttribute("tableId"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"recordId\" id=\"recordId\" value=\"");
      out.print((recordId!=null && !recordId.toUpperCase().equals("NULL") && recordId.length()>0) ? recordId : WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getAttribute("recordId"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"workType\" id=\"workType\" value=\"");
      out.print(workType );
      out.write("\">\r\n<input type=\"hidden\" name=\"processName\" id=\"processName\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("processName"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"curActivityId\" id=\"curActivityId\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("activity"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"curActivityName\" id=\"curActivityName\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("activityName"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"submitPerson\" id=\"submitPerson\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("submitPerson"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"submitPersonId\" id=\"submitPersonId\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("submitPersonId"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"stepCount\" id=\"stepCount\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("stepCount"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"remindField\" id=\"remindField\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getAttribute("remindField"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"isStandForWork\" id=\"isStandForWork\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("isStandForWork"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"standForUserId\" id=\"standForUserId\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("standForUserId"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"standForUserName\" id=\"standForUserName\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("standForUserName"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"mainLinkFile\" id=\"mainLinkFile\" value=\"");
      out.print(mainLinkFile );
      out.write("\">\r\n<input type=\"hidden\" name=\"page_token\" id=\"page_token\" value=\"");
      out.print(Calendar.getInstance().getTimeInMillis());
      out.write("\"/>\r\n<input type=\"hidden\" name=\"titleFieldName\" id=\"titleFieldName\" value=\"");
      out.print(titleFieldName );
      out.write("\">\r\n<!-- <input type=\"hidden\" name=\"title\" value=\"");
//=title
      out.write("\"> -->\r\n<input type=\"hidden\" name=\"processId\" id=\"processId\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("processId"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"msgFrom\" id=\"msgFrom\" value=\"");
      out.print(msgFrom );
      out.write("\">\r\n<input type=\"hidden\" name=\"inWorkType\" id=\"inWorkType\" value=\"");
      out.print(inWorkType );
      out.write("\">\r\n<input type=\"hidden\" name=\"submitTime\" id=\"submitTime\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("submitTime"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"submitPersonTime\" id=\"submitPersonTime\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("submitTime"))) );
      out.write("\">\r\n<input type=\"hidden\" name=\"initActivity\" id=\"initActivity\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("initActivity"))) );
      out.write("\">\r\n<input type=\"hidden\" id=\"workPrarllelCurActId\" name=\"workPrarllelCurActId\" value=\"");
      out.print(curParallelActId);
      out.write("\" />\r\n<input type=\"hidden\" id=\"curActivityIsBranch\" name=\"curActivityIsBranch\" value=\"");
      out.print(request.getAttribute("curActivityIsBranch")==null?"0":request.getAttribute("curActivityIsBranch"));
      out.write("\" />\r\n<input type=\"hidden\" id=\"branchActInfo\" name=\"branchActInfo\" value=\"\">\r\n\r\n<!-- 新增表单域 -->\r\n<input type=\"hidden\" name=\"isSend\" id=\"isSend\" value=\"0\"><!-- 是否发送事件 -->\r\n<input type=\"hidden\" name=\"fromdesktop\" id=\"fromdesktop\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("fromdesktop"))) );
      out.write("\">\r\n<INPUT TYPE=\"hidden\" name=\"operName\" id=\"operName\">\r\n<INPUT TYPE=\"hidden\" name=\"operId\" id=\"operId\" >\r\n<input type=hidden name=mainUserType id=\"mainUserType\" value=100><!--参与人类型-->\r\n<input type=hidden name=mainAllowStandFor id=\"mainAllowStandFor\" value=0>\r\n<input type=hidden name=mainAllowCancel id=\"mainAllowCancel\" value=0>\r\n<input type=hidden name=mainAllowTransition id=\"mainAllowTransition\" value=0>\r\n<input type=hidden name=mainPressType id=\"mainPressType\" value=0>\r\n<input type=hidden name=mainDeadLineTime id=\"mainDeadLineTime\" value=-1>\r\n<input type=hidden name=mainPressMotionTime id=\"mainPressMotionTime\" value=-1>\r\n<input type=hidden name=\"mainNextActivityId\" id=\"mainNextActivityId\">\r\n<input type=hidden name=\"mainNextActivityName\" id=\"mainNextActivityName\">\r\n<input type=hidden name=\"emergence\" id=\"emergence\" value=0><!--缓急程度-->\r\n<input type=hidden name=\"needSendMsg\" id=\"needSendMsg\" ><!--短信-->\r\n<input type=hidden name=\"smsContent\" id=\"smsContent\"><!--短信内容-->\r\n<input type=hidden name=\"dealTips\" id=\"dealTips\" ><!--tips内容-->\r\n");
      out.write("<input type=hidden name=\"processDeadlineDate\" id=\"processDeadlineDate\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("processDeadlineDate"))) );
      out.write("\"><!--流程办理期限-->\r\n");
String[][] sendMsgToInit = new DataSourceBase().queryArrayBySql("SELECT sendMsgToInitiator,opinionmust,opinionLengthSet,opinionLengthMin,opinionLengthMax,sendMsgToDealDone FROM jsf_activity WHERE WF_ACTIVITY_ID="
		+request.getParameter("activity")); 
      out.write("\r\n<input type=\"hidden\" name=\"sendMsgToInitiator\" id=\"sendMsgToInitiator\" value=\"");
      out.print(sendMsgToInit.length>0 ? sendMsgToInit[0][0] : "0" );
      out.write("\"> <!-- 是否给发起人发送提醒 -->\r\n<input type=\"hidden\" name=\"opinionmust\" id=\"opinionmust\" value=\"");
      out.print(sendMsgToInit.length > 0 ? sendMsgToInit[0][1]:"0" );
      out.write("\"> <!-- 意见必填 -->\r\n<input type=\"hidden\" name=\"opinionLengthSet\" id=\"opinionLengthSet\" value=\"");
      out.print(sendMsgToInit.length>0 ? sendMsgToInit[0][2] : "0" );
      out.write("\"> <!-- 意见长度 -->\r\n<input type=\"hidden\" name=\"opinionLengthMin\" id=\"opinionLengthMin\" value=\"");
      out.print(sendMsgToInit.length>0 ? sendMsgToInit[0][3] : "10" );
      out.write("\"> <!-- 意见最短长度 -->\r\n<input type=\"hidden\" name=\"opinionLengthMax\" id=\"opinionLengthMax\" value=\"");
      out.print(sendMsgToInit.length>0 ? sendMsgToInit[0][4] : "1000" );
      out.write("\"> <!-- 意见最长长度 -->\r\n<input type=\"hidden\" name=\"sendMsgToDealDone\" id=\"sendMsgToDealDone\" value=\"");
      out.print(sendMsgToInit.length>0?sendMsgToInit[0][5]:"0" );
      out.write("\"> <!-- 是否给已办人员发送提醒 -->\r\n\r\n\r\n\r\n<input type=\"hidden\" name=\"changeDeadLineTime\" id=\"changeDeadLineTime\" value=\"-1\">\r\n");
      out.write("\r\n<!--阅件参数-->\r\n<input type=hidden name=\"mainNeedPassRound\" id=\"mainNeedPassRound\" value=\"1\">\r\n<input type=hidden name=\"mainPassRoundUserType\" id=\"mainPassRoundUserType\" value=100><!--阅件人类型-->\r\n<input type=hidden name=\"passRoundId\" id=\"passRoundId\" >\r\n<input type=hidden name=\"passRoundName\" id=\"passRoundName\" >\r\n\r\n\r\n<!--子流程临时workID-->\r\n<input type=\"hidden\" name=\"subProcTempWorkId\" id=\"subProcTempWorkId\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("subProcWorkId"))) );
      out.write("\">\r\n\r\n<!--催办-->\r\n<input type=hidden name=pressUserId id=\"pressUserId\">\r\n<input type=hidden name=pressUserName id=\"pressUserName\">\r\n<input type=hidden name=pressTitle id=\"pressTitle\">\r\n<input type=hidden name=pressContent id=\"pressContent\">\r\n<input type=hidden name=pressSMS id=\"pressSMS\">\r\n\r\n<!--反馈-->\r\n<input type=hidden name=feedUserId id=\"feedUserId\">\r\n<input type=hidden name=feedUserName id=\"feedUserName\" >\r\n<input type=hidden name=feedTitle id=\"feedTitle\">\r\n<input type=hidden name=feedContent id=\"feedContent\">\r\n\r\n<!--转办-->\r\n<input type=hidden name=transitionUser id=\"transitionUser\">\r\n<input type=hidden name=transitionUserName id=\"transitionUserName\">\r\n<input type=hidden name=\"tranType\" id=\"tranType\" value=\"");
      out.print(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("tranType"))) );
      out.write("\">\r\n<input type=hidden name=\"tranFromPersonId\" id=\"tranFromPersonId\" value=\"");
      out.print(request.getParameter("tranFromPersonId")==null?"-1" : WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("tranFromPersonId"))) );
      out.write("\">\r\n\r\n<!--收回-->\r\n<input type=hidden name=receiveActivityId id=\"receiveActivityId\">\r\n<input type=hidden name=receiveActivityName id=\"receiveActivityName\">\r\n<input type=hidden name=receiveUserName id=\"receiveUserName\">\r\n\r\n<!--阅件-->\r\n<input type=hidden name=\"passLinkFile\" id=\"passLinkFile\" value=\"");
      out.print(passLinkFile);
      out.write("\">\r\n\r\n<!--当前节点办理方式--默认'1'为多人并行-->\r\n<input type=hidden name=approveMode value=\"1\" id=\"approveMode\">\r\n\r\n<input type=hidden name=saveCheckFn id=\"saveCheckFn\"  value=\"");
      out.print(saveCheckFn);
      out.write("\">\r\n<input type=hidden name=formName id=\"formName\" value=\"");
      out.print(formName);
      out.write("\">\r\n<input type=hidden name=bodyContent id=\"bodyContent\" value=\"\">\r\n\r\n<!--流程按钮-->\r\n");

com.js.oa.jsflow.service.WorkFlowBD workFlowBD = new com.js.oa.jsflow.service.WorkFlowBD();
com.js.oa.jsflow.service.WorkFlowCommonBD workFlowCommonBD = new com.js.oa.jsflow.service.WorkFlowCommonBD();
com.js.oa.jsflow.service.WorkFlowButtonBD wfbd = new com.js.oa.jsflow.service.WorkFlowButtonBD();
String moduleId = workFlowCommonBD.getModuleId(tableId);//模块ID
String operButton = "";

/*if(inWorkStatus==101){
	modiButton = ",Print";	
}*/

//流程中显示按钮
if("none".equals(modiButton)){
	com.js.oa.jsflow.vo.ActivityVO avo = workFlowBD.getProceedActiVO(request.getParameter("table"),request.getParameter("record"),request.getParameter("activity"),"0");
	operButton = avo.getOperButton();
	if(operButton!=null && !"".equals(operButton)){
		operButton = operButton.replaceAll("cmd",",");
	}
	
	modiButton =  "";
	if(inWorkStatus==0){
		//待办

		//发文
		if("1".equals(moduleId) || "2".equals(moduleId) || "3".equals(moduleId) || (Integer.parseInt(moduleId)>=200 && Integer.parseInt(moduleId)<=300)){
			modiButton +=  ",Saveclose";
		}

		//起草正文
		if(operButton.indexOf("Writetext")!=-1){
			modiButton += ",Writetext";
		}

		//引入正文
		if(operButton.indexOf("Imptext")!=-1){
			modiButton += ",Imptext";
		}

		//附件管理
		if(operButton.indexOf("Manageracc")!=-1){
			modiButton += ",Manageracc";
			modiButton = modiButton.replaceAll(",Viewacc","");
		}

		//默认显示发送
		modiButton +=  ",Send";

			//显示【办理完毕】按钮,不为代办且为多人审批时显示办理完毕按钮
			//com.js.oa.jsflow.service.WorkFlowButtonBD wfbd = new com.js.oa.jsflow.service.WorkFlowButtonBD();
			boolean showEnd = wfbd.hasMoreDealFile(workVO);
			if(!"1".equals(request.getParameter("isStandForWork")) && showEnd){
				modiButton = modiButton.replaceAll("Send","End");
			}else if("1".equals(request.getParameter("isStandForWork")) && showEnd && ("3".equals(curTransactType) || "1".equals(curTransactType))){
				//当是多人并行或串行时，是代办人的情况也只显示办理完毕
				modiButton = modiButton.replaceAll("Send","End");
			}

			//自动返回节点显示【办理完毕】按钮
			String[] activityInfo = workFlowBD.getActivityClass(request.getParameter("table"), request.getParameter("record"), ("0".equals(curParallelActId))?request.getParameter("activity"):curParallelActId);
			if("3".equals(activityInfo[0])){
				//自动返回节点
				modiButton = modiButton.replaceAll("Send","EndAutoReturn");		
			}
			
			//转办后自动返回待办文件显示【办理完毕】按钮
			String tranType = request.getParameter("tranType")==null?"0":request.getParameter("tranType");
			if("1".equals(tranType)){
				modiButton = modiButton.replaceAll("Send","EndAutoReturn");		
			}

			//后继为结束节点显示【办理完毕】按钮
			java.util.List activityList = workFlowBD.getAllNextActivity(request.getParameter("table"), request.getParameter("record"), ("0".equals(curParallelActId))?request.getParameter("activity"):curParallelActId);
			if(activityList.size()==1 && ((com.js.oa.jsflow.vo.ActivityVO) activityList.get(0)).getBeginEnd() == 2){
				//后继为结束节点
				modiButton = modiButton.replaceAll("Send","EndOnlyComp");		
			}
		
		//转办
		if(operButton.indexOf("Tran")!=-1){
			//转办(Tran)，转阅(TranRead) 会混淆 故判断较复杂		
			if("Tran".equals(operButton) || ",Tran".equals(operButton)){
				modiButton += ",Tran";
			}else{
				if(operButton.endsWith("Tran") || operButton.startsWith("Tran,")){
					modiButton += ",Tran";
				}else{
					if(operButton.indexOf(",Tran,")!=-1){
						modiButton += ",Tran";
					}
				}
			}
			
		}

		//退回
		if(operButton.indexOf("Back")!=-1){
			modiButton += ",Back";
		}

		//反馈
		if(operButton.indexOf("Feedback")!=-1){
			modiButton += ",Feedback";
		}

		//打印
		if(operButton.indexOf("Print")!=-1){
			modiButton += ",Print";
		}

		//作废
		if(operButton.indexOf("Delete")!=-1){
			modiButton += ",Delete";
		}

		//查看正文
		if(operButton.indexOf("Viewtext")!=-1){
			modiButton += ",Viewtext";
		}

		//查看附件
		if(operButton.indexOf("Viewacc")!=-1){
			modiButton += ",Viewacc";
		}

		//打印阅办单
		if(operButton.indexOf("Printcomm")!=-1){
			modiButton += ",Printcomm";
		}

		//打印正文
		if(operButton.indexOf("Printtext")!=-1){
			modiButton += ",Printtext";
		}

		//附件管理
		if(operButton.indexOf("Manageracc")!=-1){
			//modiButton += ",Manageracc";
			modiButton = modiButton.replaceAll(",Viewacc","");
		}

		//归档
		if(operButton.indexOf("Document")!=-1){
			modiButton += ",Document";
		}

		//正文管理
		if(operButton.indexOf("Textmanager")!=-1){
			modiButton += ",Textmanager";
		}

		//批阅正文
		if(operButton.indexOf("Readtext")!=-1){
			modiButton += ",Readtext";
			modiButton = modiButton.replaceAll(",Viewtext","");
		}

		//生成正式文件
		if(operButton.indexOf("Savefile")!=-1){
			modiButton += ",Savefile";
			modiButton = modiButton.replaceAll(",Viewtext","");
			//modiButton = modiButton.replaceAll(",Readtext","");
		}

		//编号
		if(operButton.indexOf("Code")!=-1){
			modiButton += ",Code";
		}

		//内部分发
		if(operButton.indexOf("Selfsend")!=-1){
			modiButton += ",Selfsend";
		}

		//转本部门
		if(operButton.indexOf("Toselfdept")!=-1){
			modiButton += ",Toselfdept";
		}

		//分发
		if(operButton.indexOf("Sendclose")!=-1){
			modiButton += ",Sendclose";
		}


	} else if(inWorkStatus==1011 || inWorkStatus==101){
		//在办
		avo = workFlowBD.getProceedActiVO(request.getParameter("table"),request.getParameter("record"),request.getParameter("initActivity"),"0");
		operButton = avo.getOperButton();
		if(operButton!=null && !"".equals(operButton)){
			operButton = operButton.replaceAll("cmd",",");
		}

		//撤办(超过一步不显示撤办)
		if(operButton.indexOf("Undo")!=-1 && wfbd.showUndoButton(workVO)){
			modiButton += ",Undo";
		}

		//催办
		if(operButton.indexOf("Wait")!=-1){
			modiButton += ",Wait";
		}

		//反馈
		if(operButton.indexOf("Feedback")!=-1){
			modiButton += ",Feedback";
		}

		//收回
		if(operButton.indexOf("Return")!=-1){
			modiButton += ",Return";
		}

		//打印
		if(operButton.indexOf("Print")!=-1){
			modiButton += ",Print";
		}

		//转阅
		/*if(operButton.indexOf("TranRead")!=-1){
			modiButton += ",TranRead";
		}*/

		//发文
		//if("2".equals(moduleId) || "3".equals(moduleId)){
		if("2".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Printtext,Viewread";
		}

		//收文
		if("3".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Viewread";
		}

		//文件送审签
		if("34".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc";
		}

		//增加批阅人
		/*if(operButton.indexOf("Addperson")!=-1){
			modiButton += ",Addperson";
		}*/

	} else if(inWorkStatus==1012){
		//办结
		avo = workFlowBD.getProceedActiVO(tableId, recordId, request.getParameter("initActivity"), "0");
		operButton = avo.getOperButton();
		if(operButton!=null && !"".equals(operButton)){
			operButton = operButton.replaceAll("cmd", ",");
		}

		//收回
		/*if(operButton.indexOf("Return")!=-1){
			modiButton += ",Return";
		}*/
		
		//反馈
		if(operButton.indexOf("Feedback") != -1){
			modiButton += ",Feedback";
		}

		//打印
		if(operButton.indexOf("Print") != -1){
			modiButton += ",Print";
		}

		//转阅
		/*if(operButton.indexOf("TranRead")!=-1){
			modiButton += ",TranRead";
		}*/

		//发文
		if("2".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Printtext,Viewread";
		}

		//收文
		if("3".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Viewread";
		}

		//文件送审签
		if("34".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc";
		}

	} else if(inWorkStatus==2){
		//待阅
		modiButton +=  ",End";

		//反馈
		if(operButton.indexOf("Feedback")!=-1){
			modiButton += ",Feedback";
		}

		//转阅
		if(operButton.indexOf("TranRead")!=-1){
			modiButton += ",TranRead";
		}

		//发文
		if("2".equals(moduleId) || "3".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Printtext";
		}
		//文件送审签
		if("34".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc";
		}
		
	} else if(inWorkStatus==102){
		//已阅

		//转阅
		/*if(operButton.indexOf("TranRead")!=-1){
			modiButton += ",TranRead";
		}*/

		//发文
		if("2".equals(moduleId) || "3".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Printtext";
		}
		//文件送审签
		if("34".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc";
		}

	} else if(inWorkStatus==1){
		//我的在办

		//打印
		//if(operButton.indexOf("Print")!=-1){
			modiButton += ",Print";
		//}

		//催办
		//if(operButton.indexOf("Wait")!=-1){
			modiButton += ",Wait";
		//}

		//发文
		if("2".equals(moduleId) || "3".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Printtext";
		}

		//文件送审签
		if("34".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc";
		}
		//取消
		if(operButton.indexOf("Cancel")!=-1 && "dealwith".equals(WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("from"))))){
			modiButton += ",Cancel";
		}

	} else if(inWorkStatus==100){
		//我的办结

		modiButton += ",Print";

		//发文
		if("2".equals(moduleId) || "3".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Printtext";
		}

		//文件送审签
		if("34".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc";
		}

	} else if(inWorkStatus==-1){
		//我的退回
		//发文
		if("2".equals(moduleId) || "3".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Printtext";
		}
		//文件送审签
		if("34".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc";
		}


	} else if(inWorkStatus==-2){
		//我的取消
		//发文
		if("2".equals(moduleId) || "3".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc,Printcomm,Printtext";
		}
		//文件送审签
		if("34".equals(moduleId)){
			modiButton +=  ",Viewtext,Viewacc";
		}

	}

	//通用公文按钮
		//转收文
		if(operButton.indexOf("Toreceive")!=-1){
			modiButton += ",Toreceive";
		}
		//转发文
		if(operButton.indexOf("Tosend")!=-1){
			modiButton += ",Tosend";
		}
		//转文件按送审签
		if(operButton.indexOf("Tocheck")!=-1){
			modiButton += ",Tocheck";
		}

	if("".equals(modiButton) && inWorkStatus==101){
		modiButton = ",Print";	
	}

	//隐藏查看附件按钮
	modiButton = modiButton.replaceAll("Viewacc,","").replaceAll("Viewacc","").replaceAll("Printcomm,","").replaceAll("Printcomm","").replaceAll("Printtext,","").replaceAll("Printtext","");
	modiButton = modiButton.replaceAll("Manageracc,","").replaceAll("Manageracc","").replaceAll("Textmanager,","").replaceAll("Textmanager","");
	modiButton = modiButton.replaceAll("Document,","").replaceAll("Document","").replaceAll("Toselfdept,","").replaceAll("Toselfdept","");

} 


//办理查阅时按钮
operButton = modiButton;

/****************************************************************************************************/
/*在线用户锁处理*/
/****************************************************************************************************/

//在线参数
String onlineEditUser = "";//帐号
String onlineEditUserName = "";//人名
String onlineWorkId = "";//
boolean onlineUserValidate = false;

//多人并行时判断在线用户同时编辑
java.util.Map para = new java.util.HashMap();
java.text.SimpleDateFormat dfTime = new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss");//设置日期格式
para.put("recordId", recordId);
para.put("tableId", tableId);
para.put("processId", request.getParameter("processId"));
para.put("userAccount", session.getAttribute("userAccount").toString());
para.put("userName", session.getAttribute("userName").toString());
para.put("workId", workId);
para.put("pageKey",pageKey);
para.put("onlinebegintime",dfTime.format(new Date()).toString());

//返回在线编辑人员
String[] userArr = wfbd.getWFOnlineUser(para);
onlineEditUser = userArr[0];
onlineEditUserName = userArr[1];
onlineWorkId = userArr[2];
if("".equals(onlineEditUser)){
	onlineUserValidate=false;
}else if(onlineEditUser.equals(session.getAttribute("userAccount").toString())){
	onlineUserValidate=false;
}else{
	onlineUserValidate=true;
}

if(onlineEditUser.equals(session.getAttribute("userAccount").toString()) && onlineWorkId.equals(request.getParameter("work"))){
	onlineUserValidate = false;
	para.put("workId",onlineWorkId);
	wfbd.delWFOnlineUser(para);
	para.put("workId", workId);
}

//上锁
//if(!onlineUserValidate && ("0".equals(request.getParameter("workStatus")) || "1012".equals(request.getParameter("workStatus")) || "1011".equals(request.getParameter("workStatus")))){
if(!onlineUserValidate && inWorkStatus==0){ //只在办理的时候上锁	
	
	
	wfbd.setWFOnlineUser(para);
	onlineEditUser=session.getAttribute("userAccount").toString();//新进员工
	onlineEditUserName=session.getAttribute("userName").toString();//新进员工
	onlineWorkId = request.getParameter("work");
}

//在线编辑提醒
//if(onlineUserValidate && !onlineEditUser.equals(session.getAttribute("userAccount").toString())){//不判断本人
if(onlineUserValidate){//判断本人
		operButton = "";
	
      out.write("\r\n\t<SCRIPT LANGUAGE=\"JavaScript\">\r\n\tvar onlineUser = \"");
      out.print(onlineEditUserName);
      out.write('(');
      out.print(onlineEditUser);
      out.write(')');
      out.print(Resource.getValue(localhi,"workflow","workflow.includeediting"));
      out.write("\";\r\n\tweixinMessageReminder(\"alert\", \"提示：\", onlineUser, \"\");\r\n\t</SCRIPT>\r\n\t");

}	

      out.write("\r\n<SCRIPT LANGUAGE=\"JavaScript\">\r\nfunction sendRequest(recordId, tableId, processId, workId)\r\n{\r\n\tvar xmlhttp;\r\n\t//开始初始化XMLHttpRequest对象\r\n\tif(window.XMLHttpRequest) { //Mozilla 浏览器\r\n\t\txmlhttp = new XMLHttpRequest();\r\n\t\tif (xmlhttp.overrideMimeType) {//设置MiME类别\r\n\t\t\txmlhttp.overrideMimeType('text/xml');\r\n\t\t}\r\n\t}\r\n\telse if (window.ActiveXObject) { // IE浏览器\r\n\t\ttry {\r\n\t\t\txmlhttp = new ActiveXObject(\"Microsoft.XMLHTTP\");\r\n\t\t} catch (e) {\r\n\t\t\ttry {\r\n\t\t\t\txmlhttp = new ActiveXObject(\"MSXML2.XMLHTTP\");\r\n\t\t\t} catch (e) {\r\n\t\t\t\talert(\"您看到此信息，说明您的浏览器不支持XML解析。\\r\\n请在弹出页面中下载XML解析器并安装！\");\r\n\t\t\t\tJSMainWinOpen('/jsoa/public/select_user/XMLSetup.html','下载说明','toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=10,height=10');\r\n\t\t\t}\r\n\t\t}\r\n\t}\t\r\n\txmlhttp.open(\"POST\",\"/jsoa/jsflow/closeWindow.jsp?recordId=\"+recordId+\"&tableId=\"+tableId+\"&processId=\"+processId+\"&workId=\"+workId,false);\r\n\txmlhttp.send();\r\n}\r\n</SCRIPT>\r\n\r\n");


//用户退出当前页面,在线编辑解锁函数
//if(!onlineUserValidate && (("0".equals(request.getParameter("workStatus")) || "1012".equals(request.getParameter("workStatus")) || "1011".equals(request.getParameter("workStatus"))))){

      out.write("\r\n\t<SCRIPT FOR=window EVENT=onbeforeunload>\r\n\tsendRequest(\"");
      out.print(recordId);
      out.write('"');
      out.write(',');
      out.write('"');
      out.print(tableId);
      out.write('"');
      out.write(',');
      out.write('"');
      out.print(processId);
      out.write('"');
      out.write(',');
      out.write('"');
      out.print(workId);
      out.write("\");\r\n\t</SCRIPT>\r\n");

//}

/****************************************************************************************************/

      out.write("\r\n\r\n\r\n<!--记录待办首次查看时间-->\r\n");

if(inWorkStatus == 0 || inWorkStatus==2){
	com.js.oa.jsflow.vo.WorkLogVO workLogVO = new com.js.oa.jsflow.vo.WorkLogVO();
		workLogVO.setSendUserId(session.getAttribute("userId").toString());
		workLogVO.setSendUserName(session.getAttribute("userName").toString());
		workLogVO.setSendAction((request.getParameter("activityName")==null || "".equals(request.getParameter("activityName")) || "null".equals(request.getParameter("activityName"))?"" : WorkflowForWeiXinUtil.decordStr(WorkflowForWeiXinUtil.decordStr(request.getParameter("activityName"))))+"签收");
		workLogVO.setReceiveUserName(" ");
		workLogVO.setProcessId(request.getParameter("processId"));
		workLogVO.setTableId(request.getParameter("table"));
		workLogVO.setRecordId(request.getParameter("record"));
		workLogVO.setDomainId(session.getAttribute("domainId").toString());
	new com.js.oa.jsflow.service.WorkFlowButtonBD().setWorkViewedDate(workId,workLogVO,String.valueOf((Integer.parseInt(request.getParameter("stepCount")==null || "null".equals(request.getParameter("stepCount"))?"0":request.getParameter("stepCount")) - 1)));
}

      out.write("\r\n<!--待办首次查看时间-->\r\n\r\n");

if(request.getParameter("processId") != null && !"null".equals(request.getParameter("processId"))){
//表示是走了流程的

boolean handSignInUse1 = false;//是否使用了手写签名
java.util.Map include_sysMap1 = com.js.system.util.SysSetupReader.getInstance().getSysSetupMap(session.getAttribute("domainId").toString());
if(include_sysMap1 != null && include_sysMap1.get("使用手写意见") != null && "1".equals(include_sysMap1.get("使用手写意见").toString())){
    handSignInUse1 = true;
}

//int inWorkType = ("null".equals(request.getParameter("workType")) || request.getParameter("workType")==null)?-1:Integer.parseInt(request.getParameter("workType"));//流程类型 0随机流程,1业务流程
/*com.js.oa.jsflow.service.WorkFlowBD inc_wfbd = new com.js.oa.jsflow.service.WorkFlowBD();
java.util.ArrayList alist = new java.util.ArrayList();
if(inWorkStatus == 0){
    //将工作任务的可撤销(workAllowCancle)置为0
    alist.add("update jsdb.JSF_WORK set workAllowCancel = 0 where worktable_id = " + request.getParameter("table") + " and workrecord_id = " + request.getParameter("record") + " and workStepCount = " + (Integer.parseInt("null".equals(request.getParameter("stepCount"))?"0":request.getParameter("stepCount")) - 1) );
}
inc_wfbd.updateTable(alist);
*/

      out.write("\r\n\r\n<input type=\"hidden\" name=\"moduleId\" id=\"moduleId\" value=\"");
      out.print(moduleId);
      out.write("\">\r\n<input type=\"hidden\" name=\"curTransactType\" id=\"curTransactType\" value=\"");
      out.print(curTransactType);
      out.write("\">\r\n<table align=\"center\" width=\"100%\" border=\"0\" id=\"inc_tb\">\r\n\r\n");

    if(inWorkStatus == 0 || inWorkStatus == 2){
    //待批或待阅文件
  
        //业务流程
        if(inWorkStatus == 0){
            //待批文件
            com.js.oa.jsflow.service.WorkFlowBD include_workFlowBD = new com.js.oa.jsflow.service.WorkFlowBD();
            String[] include_actiClass = null;
            if("".equals(subProcWorkId)){
            include_actiClass = include_workFlowBD.getActivityClass(request.getParameter("table"), request.getParameter("record"), ("0".equals(curParallelActId))?request.getParameter("activity"):curParallelActId);
            }else{
            include_actiClass = include_workFlowBD.getActivityClass(request.getParameter("table"), request.getParameter("record"), ("0".equals(curParallelActId))?request.getParameter("activity"):curParallelActId,subProcWorkId);
            }
            
            if(include_actiClass[0].equals("0")){
                //子过程节点
            
      out.write("\r\n                <tr style=\"display:");
      out.print("1".equals(request.getParameter("transend"))?"none":"");
      out.write("\">\r\n                    <td><span style=\"cursor:pointer\" onclick=\"createSubProcess('");
      out.print(subProcHref);
      out.write("&processId=");
      out.print(include_actiClass[1]);
      out.write("&tableId=");
      out.print(include_actiClass[3]);
      out.write("&processName=");
      out.print(include_actiClass[4]);
      out.write("&processType=");
      out.print(include_actiClass[5]);
      out.write("&remindField=");
      out.print(include_actiClass[6]);
      out.write("&subProc=1&isSubProcWork=1&pareProcActiId=");
      out.print(request.getParameter("activity"));
      out.write("&pareStepCount=");
      out.print(request.getParameter("stepCount"));
      out.write("&pareTableId=");
      out.print(request.getParameter("table"));
      out.write("&pareRecordId=");
      out.print(request.getParameter("record"));
      out.write("&subProcess=1','','menubar=0,scrollbars=yes,locations=0,width=400,height=200,resizable=yes');\"><a href=\"#\">启动“");
      out.print(include_actiClass[4]);
      out.write("”(子流程)</a></span></td>\r\n                </tr>\r\n                <input type=\"hidden\" name=\"subProcType\" id=\"subProcType\" value=\"");
      out.print(include_actiClass[2]);
      out.write("\">\r\n                <input type=\"hidden\" name=\"subProcName\" id=\"subProcName\" value=\"");
      out.print(include_actiClass[4]);
      out.write("\">\r\n                <input type=\"hidden\" name=\"subProcId\" id=\"subProcId\" value=\"");
      out.print(include_actiClass[1]);
      out.write("\">\r\n                <input type=\"hidden\" name=\"processId\" id=\"processId\" value=\"");
      out.print(include_actiClass[1]);
      out.write("\">\r\n                <input type=\"hidden\" name=\"subProcTableId\" id=\"subProcTableId\" value=\"");
      out.print(include_actiClass[3]);
      out.write("\">\r\n                <input type=\"hidden\" name=\"subProcessType\" id=\"subProcessType\" value=\"");
      out.print(include_actiClass[5]);
      out.write("\">\r\n                <input type=\"hidden\" name=\"subRemindField\" id=\"subRemindField\" value=\"");
      out.print(include_actiClass[6]);
      out.write("\">\r\n                <input type=\"hidden\" name=\"subProcWorkId\" id=\"subProcWorkId\" value=\"");
      out.print(subProcWorkId );
      out.write("\">\r\n                <input type=\"hidden\" name=\"subWorkstatus\" id=\"subWorkstatus\" value=\"");
      out.print(include_actiClass[7]);
      out.write("\">\r\n            ");

            }
            
      out.write("\r\n            <input type=\"hidden\" name=\"activityClass\" id=\"activityClass\" value=\"");
      out.print(include_actiClass[0]);
      out.write("\">\r\n            \r\n           \r\n        ");

        }
    
}
      out.write("\r\n\t<!-- \r\n        <tr>\r\n            <td height=\"40\">&nbsp;</td>\r\n        </tr>\r\n       -->  \r\n    </table>\r\n    <input type=\"hidden\" name=\"include_comment\" id=\"include_comment\">\r\n    ");

    if(inWorkStatus == 0){
        //待批文件,取批示意见对应字段
        if(curCommField != null && !curCommField.equals("")){
        
      out.write("\r\n            <input type=\"hidden\" name=\"include_commField\" id=\"include_commField\" value=\"");
      out.print(curCommField);
      out.write("\">\r\n        ");

        }
    }else{
        //待阅文件,取阅示意见对应字段
        if(curPassRoundCommField != null && !curPassRoundCommField.equals("")){
            
      out.write("\r\n            <input type=\"hidden\" name=\"include_commField\" id=\"include_commField\" value=\"");
      out.print(curPassRoundCommField);
      out.write("\">\r\n        ");

        }
    }

      out.write("\r\n\r\n<!-- 阅件提交的iframe，避免关闭页面 -->\r\n<iframe id=\"tempIframe\" name=\"tempIframe\" style=\"display:none\"></iframe>\r\n\r\n<script language=\"javascript\">\r\nvar include_td1HTML = \"\";\r\nif(document.all.include_td1){\r\n    include_td1HTML = document.all.include_td1.innerHTML;\r\n}\r\n\r\n//阅件时保存意见\r\nfunction include_save(){\r\n    if(!include_saveSignature()){\r\n        return;\r\n    }\r\n    var backto = document.getElementById(\"backto\").value;\r\n    include_setComment();\r\n    //document.all.");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n    document.all.");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=dealpassround&backto=\" + backto;\r\n    document.all.");
      out.print(formName);
      out.write(".submit();\r\n    //include_close();\r\n}\r\n\r\n//取消显示退回信息\r\nfunction include_backCacnel(){\r\n    document.all.include_td1.innerHTML = include_td1HTML;\r\n}\r\n\r\n//按钮提交退回\r\nfunction include_backSubmit(include_backActivity,backto){\r\n    if(!include_saveSignature()){       \r\n        return;\r\n    }\r\n    include_setComment();\r\n    var submitTime=document.getElementById(\"submitTime\").value;\r\n\tvar tmpPerson = \"\", backToUserName = \"\";\r\n    var tmp = include_backActivity;\r\n    var formAction = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=back&submitTime=\"+submitTime+\"&backto=\"+backto;\r\n    if(tmp == 0){\r\n        //退回发起人\r\n        backToUserName = document.all.submitPerson.value;\r\n        formAction += \"&type=0&backToUserName=\" + encodeURI(encodeURI(backToUserName)) + \"&backToActivityName=\" + encodeURI(encodeURI(\"发起人\"));\r\n\t\ttmpPerson = \"发起人\";\r\n    }else{\r\n        //退回到其他步骤\r\n        tmpArr = tmp.split(\",\");\r\n        backToUserName =  tmpArr[4];\r\n        formAction += \"&type=1&backToUserId=\" + tmpArr[3] +\"&backToUserName=\" +encodeURI(encodeURI(backToUserName)) + \"&backToActivityId=\" + tmpArr[0] + \"&backToStep=\" + tmpArr[1] + \"&backToActivityName=\" + encodeURI(encodeURI(tmpArr[2]));\r\n");
      out.write("\t\ttmpPerson = tmpArr[2];\r\n    }\r\n    ");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n    document.all.");
      out.print(formName);
      out.write(".action = formAction;\r\n    document.all.");
      out.print(formName);
      out.write(".submit();\r\n    weixinMessageReminder(\"alert\", \"提示：\", \"已退回到\" + tmpPerson + \"[\" + decodeURI(backToUserName) + \"]\", \"include_close();\");\r\n}\r\n\r\n//按钮催办\r\nfunction include_waitSubmit(){\r\n    //发邮件\r\n\t");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n\t");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=press\";\r\n\t");
      out.print(formName);
      out.write(".submit();\r\n\tweixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includehassuccesspress"));
      out.write("\", \"include_close();\");\r\n\t//document.getElementById('commonPopDiv').style.display = 'none';\r\n\t\r\n}\r\n\r\n//按钮反馈\r\nfunction include_feedbackSubmit(){\r\n    //发邮件\r\n\t");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n\t");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=feedback\";\r\n\t");
      out.print(formName);
      out.write(".submit();\r\n\tweixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includehassuccessfeedback"));
      out.write("\", \"\");\r\n\tdocument.getElementById('formBody').style.display = 'block';\r\n\tdocument.getElementById('commonPopDiv').style.display = 'none';\r\n}\r\n\r\n//按钮撤办\r\nfunction include_undoSubmit(){\r\n\tweixinMessageReminder(\"confirm\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeconfirmundo"));
      out.write("\", \"include_undoSubmit2();\");\r\n}\r\nfunction include_undoSubmit2(){\r\n\tvar backto = document.getElementById(\"backto\").value;\r\n\tdocument.all.");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n    document.all.");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=undo&backto=\" + backto;\r\n    document.all.");
      out.print(formName);
      out.write(".submit();\r\n    //include_close();\r\n}\r\n\r\n//按钮收回\r\nfunction include_returnSubmit(){\r\n\tdocument.all.");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n    document.all.");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=return\";\r\n    document.all.");
      out.print(formName);
      out.write(".submit();\r\n    weixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includesuccessreceive"));
      out.write("\"+document.all.receiveActivityName.value+\"！\", \"include_close();\");\r\n}\r\n\r\n//按钮作废\r\nfunction include_deleteSubmit(){\r\n\tweixinMessageReminder(\"confirm\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeconfirmdelete"));
      out.write("\", \"include_deleteSubmit2();\");\r\n}\r\nfunction include_deleteSubmit2(){\r\n\tdocument.all.");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n    document.all.");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=delete\";\r\n    document.all.");
      out.print(formName);
      out.write(".submit();\r\n    //include_close();\r\n}\r\n\r\n//办理完毕与阅件保存--多人办理--待阅办理\r\nfunction include_endAndSaveSubmit(){\r\n\tif('");
      out.print(inWorkStatus);
      out.write("'=='2'){\r\n\t\t//阅件\r\n\t\tweixinMessageReminder(\"confirm\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeconfirmsaveread"));
      out.write("\", \"include_save();\");\r\n\t} else{\r\n\t\t//办理完毕\r\n\t\tweixinMessageReminder('confirm', '提示：', '");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeconfirmturntodeal"));
      out.write("', 'include_endSubmit();')\r\n\t\t\r\n\t}\r\n}\r\n\r\n//办理完毕--多人办理\r\nfunction include_endSubmit(){\r\n\tweixinMessageReminder(\"confirm\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeconfirmturntodeal"));
      out.write("\", \"include_endSubmit2();\");\r\n}\r\nfunction include_endSubmit2(){\r\n\tif(include_checkUser()){\r\n        if(");
      out.print(saveCheckFn);
      out.write("){\r\n\t\t\tif(!include_saveSignature()){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tinclude_setComment();\r\n\t\t\tvar backto = document.getElementById(\"backto\").value;\r\n\t\t\t//document.all.");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n\t\t\tdocument.all.");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=end&backto=\" + backto;\r\n\t\t\tdocument.all.");
      out.print(formName);
      out.write(".submit();\r\n\t\t\t//include_close();\r\n\t\t}\r\n\t}\r\n}\r\n\r\n//办理完毕-自动返回\r\nfunction include_endAutoReturn(){\r\n\tvar hangup=");
      out.print(hangup);
      out.write(";\r\n    if(hangup==1){\r\n    \tweixinMessageReminder(\"alert\", \"提示：\", \"该流程已挂起！\", \"\");\r\n    }else{\r\n    \tweixinMessageReminder(\"confirm\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeconfirmturntodeal"));
      out.write("\", \"include_sub2();\");\r\n    }\r\n}\r\n\r\n//办理完毕--后继唯一结束\r\nfunction include_endOnlyComp(){\r\n    weixinMessageReminder('confirm', '提示：', '");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeconfirmcompleteprocess"));
      out.write("', 'include_comp2();')\r\n}\r\n\r\n//内部分发\r\nfunction include_selfsendSubmit(type){\r\n\tvar _mainPassRoundUserType=document.all.mainPassRoundUserType.value;\r\n\tif(_mainPassRoundUserType==\"10\"){\r\n\t\t//组织领导方式按照用户处理(已经选择了领导)\r\n\t\t_mainPassRoundUserType=\"100\";\r\n\t}\r\n    switch (parseInt(_mainPassRoundUserType)) {\r\n\t\tcase 10:\r\n\t\t\t//组织领导\r\n\t\t\tvar orgId = \"\";\r\n\t\t\tvar idstr = document.all.operId.value;\r\n\t\t\tif(idstr != \"\"){\r\n\t\t\t\tfor( var i = 0; i < idstr.length; i ++ ){\r\n\t\t\t\t\tflagCode = idstr.charAt(i);\r\n\t\t\t\t\tnextPos = idstr.indexOf(flagCode,i + 1);\r\n\t\t\t\t\tstr = idstr.substring(i+1,nextPos);\r\n\t\t\t\t\tif(flagCode == \"*\"){\r\n\t\t\t\t\t\torgId = orgId + str + \",\";\r\n\t\t\t\t\t}\r\n\t\t\t\t\ti = nextPos;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\torgId = orgId.substring(0,orgId.length-1);\r\n\t\t\tdocument.all.operId.value = orgId;\r\n\t\t\tworkflowSync.getLeaderByOrgId(orgId, include_checkUserStatusSelfsend(type));\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tdocument.all.");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n\t\t\tdocument.all.");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=passround&type=\"+type;\r\n\t\t\tdocument.all.");
      out.print(formName);
      out.write(".submit();\r\n\t\t\tvar message = \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includehassuccessturn"));
      out.write("\"+(document.all.operName.value==''?\"\":(\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeto"));
      out.write("\"+document.all.operName.value))+(document.all.mainPassRoundUserType.value=='10'?\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeleader"));
      out.write("\":\"\")+\"！\"\r\n\t\t\tweixinMessageReminder(\"alert\", \"提示：\", message, \"\");\r\n\t\t\tdocument.getElementById('formBody').style.display = 'block';\r\n\t\t\tdocument.getElementById('commonPopDiv').style.display = 'none';\r\n    }\r\n}\r\n\r\n//内部分发检测用户有效\r\nfunction include_checkUserStatusSelfsend(type,s) {\r\n\t if(s==\"noleader\"){\r\n\t\t//组织领导不存在\r\n\t\talert(\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includenoleader"));
      out.write("\");\r\n\t\treturn;\r\n\t}\r\n    document.all.");
      out.print(formName);
      out.write(".target = \"tempIframe\";\r\n    document.all.");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonAction.do?flag=passround&type=\"+type;\r\n    document.all.");
      out.print(formName);
      out.write(".submit();\r\n\talert(\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includehassuccessturn"));
      out.write("\"+(document.all.operName.value==''?\"\":(\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeto"));
      out.write("\"+document.all.operName.value))+(document.all.mainPassRoundUserType.value=='10'?\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeleader"));
      out.write("\":\"\")+\"！\");\r\n\r\n}\r\n\r\n//转办\r\nfunction include_transTo(actiontype){\r\n    if(!include_saveSignature()){\r\n        return;\r\n    }\r\n    if(");
      out.print(saveCheckFn);
      out.write("){//表单校验函数\r\n        if(document.all.transitionUserName.value == \"\" && actiontype!='tranAutoReturn'){\r\n            weixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeseltranuser"));
      out.write("\", \"\");\r\n        }else{\r\n\t\t\tinclude_setComment();\r\n            document.all.inc_tb.style.display=\"none\";\r\n            document.all.");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n            document.all.");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowCommonForWeiXinAction.do?flag=trans&actiontype=\"+actiontype+\"&transend=");
      out.print(request.getParameter("transend"));
      out.write("\";\r\n            document.all.");
      out.print(formName);
      out.write(".submit();\r\n            weixinMessageReminder(\"alert\", \"提示：\", \"已提交给\"+document.all.transitionUserName.value+\"！\", \"include_close();\");\r\n        }\r\n    }\r\n}\r\n\r\n//用户决定流程走向时的“提交”事件\r\nfunction include_sub(){\r\n\tif(document.all.mainUserType && (document.all.mainUserType.value==\"0\" || document.all.mainUserType.value==\"7\")){\r\n\t\tif(!document.all.mainCandidateUser){\r\n\t\t\tweixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includenotsetupleader"));
      out.write("\", \"\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n    var i = 0;\r\n    if(document.all.nextActivity){\r\n        if(document.all.nextActivity.length){\r\n            for(var j = 0; j < document.all.nextActivity.length; j ++){\r\n                if(document.all.nextActivity[j].checked){\r\n                    i = 1;\r\n                    break;\r\n                }\r\n            }\r\n        }else{\r\n            if(document.all.nextActivity.checked){\r\n                i = 1;\r\n            }\r\n        }\r\n    }\r\n    if(include_checkUser()){\r\n        if(");
      out.print(saveCheckFn);
      out.write("){\r\n            if(!include_saveSignature()){\r\n                return;\r\n            }\r\n            include_setComment();\r\n\r\n\t\t\t//发送标记\r\n\t\t\tdocument.all.isSend.value = 1;\r\n\r\n\t\t\tvar _userType=document.all.mainUserType.value;\r\n        \tif(_userType==\"10\"){\r\n        \t\t//选择方式是部门领导的，已经将领导empId,empName 取出，按照用户处理\r\n        \t\t_userType=\"100\";\r\n        \t}\r\n        \t\r\n            switch (parseInt(_userType)) {\r\n\t\t\t\tcase 100:\r\n                    //新节点\r\n                    var empId = \"\";\r\n                    var orgId = \"\";\r\n                    var groupId = \"\";\r\n                    var idstr = document.all.operId.value;\r\n                    if(idstr != \"\"){\r\n                        for( var i = 0; i < idstr.length; i ++ ){\r\n                            flagCode = idstr.charAt(i);\r\n                            nextPos = idstr.indexOf(flagCode,i + 1);\r\n                            str = idstr.substring(i,nextPos+1);\r\n                            if(flagCode == \"$\"){\r\n                                empId = empId + str;\r\n                            }else if(flagCode == \"*\"){\r\n");
      out.write("                                orgId = orgId + str;\r\n                            }else{\r\n                                groupId = groupId + str;\r\n                            }\r\n                            i = nextPos;\r\n                        }\r\n                    }\r\n                    workflowSync.getUserStatusByEmpOrgGrp(empId, orgId, groupId, include_checkUserStatus);\r\n                    break;\r\n\r\n\t\t\t\tcase 10:\r\n                    //组织领导\r\n                    var orgId = \"\";\r\n                    var idstr = document.all.operId.value;\r\n                    if(idstr != \"\"){\r\n                        for( var i = 0; i < idstr.length; i ++ ){\r\n                            flagCode = idstr.charAt(i);\r\n                            nextPos = idstr.indexOf(flagCode,i + 1);\r\n                            str = idstr.substring(i+1,nextPos);\r\n                            if(flagCode == \"*\"){\r\n                                orgId = orgId + str + \",\";\r\n                            }\r\n                            i = nextPos;\r\n");
      out.write("                        }\r\n                    }\r\n\t\t\t\t\torgId = orgId.substring(0,orgId.length-1);\r\n\t\t\t\t\tdocument.all.operId.value = orgId;\r\n                    workflowSync.getLeaderByOrgId(orgId, include_checkUserStatus);\r\n                    break;\r\n\r\n                default:\r\n                    break;\r\n            }\r\n            ");
      out.write("\r\n        }\r\n    }\r\n}\r\nfunction include_branch_sub(){\r\n\tif(");
      out.print(saveCheckFn);
      out.write("){\r\n\t\tif(confirm(\"您确定提交处理吗？\")){\r\n            document.all.inc_tb.style.display=\"none\";\r\n            include_setComment();\r\n            ");
      out.print(formName);
      out.write(".target = \"_self\";\r\n            ");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonAction.do?flag=branchsend\";\t\t\t\r\n            ");
      out.print(formName);
      out.write(".submit();\r\n        }\r\n\t}\r\n}\r\n//流程决定走向时的“提交”事件\r\nfunction include_sub2(){\r\n    if(include_checkUser()){\r\n        if(");
      out.print(saveCheckFn);
      out.write("){\r\n            if(!include_saveSignature()){\r\n                return;\r\n            }\r\n            include_setComment();\r\n            switch (parseInt(document.all.mainUserType.value)) {\r\n                case 0:\r\n                    //流程发起人的上级领导\r\n                    var userIds = \"\";\r\n                    if(document.all.mainCandidateUser.length){\r\n                        for(i = 0; i < document.all.mainCandidateUser.length; i ++ ){\r\n                            if(document.all.mainCandidateUser[i].checked){\r\n                                userIds += document.all.mainCandidateUser[i].value + \",\";\r\n                            }\r\n                        }\r\n                    }else{\r\n                        userIds = document.all.mainCandidateUser.value;\r\n                    }\r\n                    workflowSync.getUserStatusByEmpIdStr(userIds, include_checkUserStatus);\r\n                    break;\r\n                case 1:\r\n                    //由上一节点参与者从所有用户中选择\r\n                    var empId = \"\";\r\n                    var orgId = \"\";\r\n");
      out.write("                    var groupId = \"\";\r\n                    var idstr = document.all.mainOperProcUser.value;\r\n                    if(idstr != \"\"){\r\n                        for( var i = 0; i < idstr.length; i ++ ){\r\n                            flagCode = idstr.charAt(i);\r\n                            nextPos = idstr.indexOf(flagCode,i + 1);\r\n                            str = idstr.substring(i,nextPos+1);\r\n                            if(flagCode == \"$\"){\r\n                                empId = empId + str;\r\n                            }else if(flagCode == \"*\"){\r\n                                orgId = orgId + str;\r\n                            }else{\r\n                                groupId = groupId + str;\r\n                            }\r\n                            i = nextPos;\r\n                        }\r\n                    }\r\n                    workflowSync.getUserStatusByEmpOrgGrp(empId, orgId, groupId, include_checkUserStatus);\r\n                    break;\r\n                case 2:\r\n                    //从候选人员中指定candidateUser\r\n");
      out.write("                    var userIds = \"\";\r\n                    if(document.all.mainCandidateUser.length){\r\n                        for(i = 0; i < document.all.mainCandidateUser.length; i ++ ){\r\n                            if(document.all.mainCandidateUser[i].checked){\r\n                                userIds += document.all.mainCandidateUser[i].value + \",\";\r\n                            }\r\n                        }\r\n                    }else{\r\n                        userIds = document.all.mainCandidateUser.value;\r\n                    }\r\n                    workflowSync.getUserStatusByEmpIdStr(userIds, include_checkUserStatus);\r\n                    break;\r\n                case 3:\r\n                    //指定全部办理人\r\n                    var userIds = \"\";\r\n                    if(document.all.mainAllUser.length){\r\n                        for(i = 0; i < document.all.mainAllUser.length; i ++ ){\r\n                            userIds += document.all.mainAllUser[i].value + \",\";\r\n                        }\r\n                    }else{\r\n");
      out.write("                        userIds = document.all.mainAllUser.value;\r\n                    }\r\n                    workflowSync.getUserStatusByEmpIdStr(userIds, include_checkUserStatus);\r\n                    break;\r\n                case 5:\r\n                    //流程发起人\r\n                    workflowSync.getUserStatus(document.all.submitPersonId.value, include_checkUserStatus);\r\n                    break;\r\n                case 6:\r\n                    //角色用户\r\n                    workflowSync.getUserStatusByRole(document.all.mainPartRole.value, document.all.submitPersonId.value, include_checkUserStatus);\r\n                    break;\r\n\t\t\t\tcase 100:\r\n\t\t\t\t\t//默认:自动返回节点\r\n\t\t\t\t\tinclude_checkUserStatus(\"endAutoReturn\");\r\n                default:\r\n                    break;\r\n            }\r\n            ");
      out.write("\r\n        }\r\n    }\r\n}\r\n\r\nfunction include_checkUserStatus(s) {\r\n\t if(s==\"noleader\"){\r\n\t\t//组织领导不存在\r\n\t\tweixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includenoleader"));
      out.write("\", \"\");\r\n\t\treturn;\r\n\t}\r\n    if(s == \"\"){\r\n        document.all.inc_tb.style.display=\"none\";\r\n        ");
      out.write("\r\n        var frm=document.getElementsByName(\"");
      out.print(formName);
      out.write("\")[0];\r\n\t\tfrm.target = \"myIframe\";\r\n\t\tfrm.action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=update\";\r\n\t\tfrm.submit();\r\n\t\tvar alertStr = \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includehassuccessturnto"));
      out.write("\"+document.all.operName.value+(document.all.mainUserType.value=='10'?\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeleader"));
      out.write("\":\"\")+\"[\"+document.all.mainNextActivityName.value+\"]\";\r\n\t\tweixinMessageReminder(\"alert\", \"提示：\", alertStr, \"alertAndBack();\");\r\n    } else if(s == \"endAutoReturn\"){\r\n\t\t//自动返回\r\n        document.all.inc_tb.style.display=\"none\";\r\n        var frm = document.getElementsByName(\"");
      out.print(formName);
      out.write("\")[0];\r\n        frm.target = \"include_iframe\";\r\n        frm.action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=update\";\r\n        weixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includehassuccessturntosign"));
      out.write("\", \"include_close();\");\r\n        frm.submit();\r\n    } else {\r\n   \t    var frm=document.getElementsByName(\"");
      out.print(formName);
      out.write("\")[0];\r\n        if(confirm(\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includenextuser"));
      out.write("：\" + s + \",");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeconfirmturntodeal"));
      out.write("\")){\r\n            document.all.inc_tb.style.display=\"none\";\r\n            frm.target = \"include_iframe\";\r\n            frm.action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=update\";\r\n            var alertStr = \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includehassuccessturnto"));
      out.write("\"+document.all.operName.value+(document.all.mainUserType.value=='10'?\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeleader"));
      out.write("\":\"\")+\"[\"+document.all.mainNextActivityName.value+\"]\";\r\n\t\t\tweixinMessageReminder(\"alert\", \"提示：\", alertStr, \"alertAndBack();\");\r\n            frm.submit();\r\n        }\r\n    }\r\n}\r\nfunction alertAndBack(str){\r\n\tinclude_close();\r\n\t\r\n}\r\n//检验办理用户\r\nfunction include_checkUser(){\r\n\tif(document.all.mainUserType && (document.all.mainUserType.value==\"0\" || document.all.mainUserType.value==\"7\")){\r\n\t\tif(!document.all.mainCandidateUser){\r\n\t\t\tparent.weixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includenotsetupleader"));
      out.write("\", \"\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n    if(document.all.mainCandidateUser){\r\n        var i = 0;\r\n        if(document.all.mainCandidateUser.length){\r\n            for(var j = 0; j < document.all.mainCandidateUser.length; j ++){\r\n                if(document.all.mainCandidateUser[j].checked){\r\n                    i = 1;\r\n                    break;\r\n                }\r\n            }\r\n        }else{\r\n            if(document.all.mainCandidateUser.checked){\r\n                i = 1;\r\n            }\r\n        }\r\n        if(i == 0){\r\n        \tparent.weixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeseldealuser"));
      out.write("\", \"\");\r\n            return false;\r\n        }\r\n    }\r\n\r\n    if(document.all.mainOperProcUserName){\r\n        if(document.all.mainOperProcUserName.value == \"\"){\r\n        \tparent.weixinMessageReminder(\"alert\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeseldealuser"));
      out.write("\", \"\");\r\n            return false;\r\n        }\r\n    }\r\n    return true;\r\n}\r\n\r\n//结束流程\r\nfunction include_comp(){\r\n\tweixinMessageReminder(\"confirm\", \"提示：\", \"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeconfirmcompleteprocess"));
      out.write("\", \"include_comp2();\");\r\n}\r\nfunction include_comp2(){\r\n\tvar backto = document.getElementById(\"backto\").value;\r\n\t\tif(");
      out.print(saveCheckFn);
      out.write("){\r\n\t\t\tif(!include_saveSignature()){\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tinclude_setComment();\r\n\t\t\tdocument.all.inc_tb.style.display=\"none\";\r\n\t\t\t");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowButtonForWeiXinAction.do?flag=complete&backto=\" + backto;\r\n\t\t\tif(document.all.moduleId.value!=\"1\"){\r\n\t\t\t\ttry{\r\n\t\t\t\t\t// 隐藏上面的菜单栏\r\n\t\t\t\t\tdocument.getElementById(\"commandBar\").style.display = \"none\";\r\n\t\t\t\t\tdocument.getElementById(\"panleAll\").style.display = \"none\";\r\n\t\t\t\t\t// 将body中的内容提交到后台，以备归档处理\r\n\t\t\t\t\tdocument.all.bodyContent.value=document.body.innerHTML;\r\n\t\t\t\t}catch(e){\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\t");

			// 如果需要归档
			if(com.js.oa.jsflow.util.WorkflowToArchive.isNeedArchive(processId)){
				
      out.write("\r\n\t\t\t\ttry{\r\n\t\t\t\t\t// 隐藏上面的菜单栏\r\n\t\t\t\t\tdocument.getElementById(\"commandBar\").style.display = \"none\";\r\n\t\t\t\t\tdocument.getElementById(\"panleAll\").style.display = \"none\";\r\n\t\t\t\t\t// 将body中的内容提交到后台，以备归档处理\r\n\t\t\t\t\tdocument.all.bodyContent.value=document.body.innerHTML;\r\n\t\t\t\t}catch(e){ }\r\n\t          \t");

			}
			
      out.write("\r\n\t\t}\r\n\t            \r\n\t\t");
      out.print(formName);
      out.write(".submit();\r\n\t\t// pullXMenuDisabledAllMenu();\r\n\t\t//");
//=formName
      out.write(".action = \"/jsoa/WorkflowCommonAction.do?flag=complete&curActivityId=\" + //document.getElementById(\"curActivityId\").value + \"&title=\" + document.getElementById(\"title\").value;\r\n\t\t//");
//=formName
      out.write(".submit();\r\n\t}\r\n}\r\n\r\n\r\n//保存手写意见 微信不判断手写意见\r\nfunction include_saveSignature(){\r\n   return true;\r\n}\r\n\r\n//批示意见\r\nfunction include_setComment(){\r\n    ");

    if(inWorkStatus == 0){
		//批示意见对应字段
        if(curCommField != null && !curCommField.equals("") && !curCommField.trim().equals("-1") && !"null".equals(curCommField)){
            if(!curCommField.startsWith("$")){
			//一个批示意见字段
        
      out.write("\r\n\t\t\tif(document.all.");
      out.print(curCommField);
      out.write("){\r\n\t\t\t\tvar commentSignType = document.all.commentSignType;\r\n\t\t\t\tif(commentSignType && document.all.");
      out.print(curCommField);
      out.write(".length){\r\n\t\t\t\t\tdocument.all.include_comment.value = document.all.");
      out.print(curCommField);
      out.write("[commentSignType.value].value;\r\n\t\t\t\t} else{\r\n\t\t\t\t\tdocument.all.include_comment.value = document.all.");
      out.print(curCommField);
      out.write(".value;\r\n                }\r\n\t\t\t}\r\n        ");

            }else{
			//多个批示意见字段
                String[] curCommFieldArr = curCommField.substring(1, curCommField.length() - 1).split("\\$\\$");
                
      out.write("\r\n                var j = 0;\r\n                commentValue = \"\";\r\n                commFieldValue = \"\";\r\n                ");

                for(int i = 0; i < curCommFieldArr.length; i ++){
      out.write("\r\n                    if(document.all.");
      out.print(curCommFieldArr[i]);
      out.write(" && document.all.");
      out.print(curCommFieldArr[i]);
      out.write(".value != \"\"){\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tvar commentSignType = document.all.commentSignType[");
      out.print(i);
      out.write("].value;\r\n\r\n                        commentValue += document.all.");
      out.print(curCommFieldArr[i]);
      out.write("[commentSignType].value + \":::\";\r\n                        commFieldValue += \"$");
      out.print(curCommFieldArr[i]);
      out.write("$\";\r\n                        j ++;\r\n                    }\r\n                ");

                }
      out.write("\r\n                if(j == 0){\r\n                    document.all.include_comment.value = document.all.");
      out.print(curCommFieldArr[0]);
      out.write("[0].value;\r\n                    document.all.include_commField.value = \"");
      out.print(curCommFieldArr[0]);
      out.write("\";\r\n                }else if(j == 1){\r\n                    commentValue = commentValue.substring(3, commentValue.length-3);\r\n                    document.all.include_comment.value = commentValue.substring(commentValue.indexOf(\";;;\") + 3, commentValue.length);\r\n                    document.all.include_commField.value = commFieldValue.substring(1, commFieldValue.length-1);\r\n                }else{\r\n                    document.all.include_comment.value = commentValue;\r\n                    document.all.include_commField.value = commFieldValue;\r\n                }\r\n                ");

            }
    	}else{
		//自动增长批示意见
        
      out.write("\r\n            if(document.all.comment){\r\n\t\t\t\tvar commentSignType = document.all.commentSignType.value;\r\n\t\t\t\tif(document.all.comment.length){\r\n\t\t\t\t\tdocument.all.include_comment.value = document.all.comment[commentSignType].value;\r\n\t\t\t\t} else{\r\n\t\t\t\t\tdocument.all.include_comment.value = document.all.comment.value;\r\n\t\t\t\t}\r\n            }\r\n        ");

        }
    }
    if(inWorkStatus == 2){
        if(curPassRoundCommField != null && !curPassRoundCommField.equals("") && !curPassRoundCommField.trim().equals("-1")){
            if(!curPassRoundCommField.startsWith("$")){
        
      out.write("\r\n\t\t\tif(document.all.");
      out.print(curPassRoundCommField);
      out.write("){\r\n\t\t\t\tvar commentSignType = document.all.commentSignType;\r\n\t\t\t\tif(commentSignType && document.all.");
      out.print(curPassRoundCommField);
      out.write(".length){\r\n\t\t\t\t\tdocument.all.include_comment.value = document.all.");
      out.print(curPassRoundCommField);
      out.write("[commentSignType.value].value;\r\n\t\t\t\t} else{\r\n\t\t\t\t\tdocument.all.include_comment.value = document.all.");
      out.print(curPassRoundCommField);
      out.write(".value;\r\n                }\r\n\t\t\t}\r\n        ");

            }else{
                String[] curCommFieldArr = curPassRoundCommField.substring(1, curPassRoundCommField.length() - 1).split("\\$\\$");
                
      out.write("\r\n                var j = 0;\r\n                commentValue = \"\";\r\n                commFieldValue = \"\";\r\n                ");

                for(int i = 0; i < curCommFieldArr.length; i ++){
      out.write("\r\n                    if(document.all.");
      out.print(curCommFieldArr[i]);
      out.write(" && document.all.");
      out.print(curCommFieldArr[i]);
      out.write(".value != \"\"){\r\n                        commentValue += document.all.");
      out.print(curCommFieldArr[i]);
      out.write(".value + \":::\";\r\n                        commFieldValue += \"$");
      out.print(curCommFieldArr[i]);
      out.write("$\";\r\n                        j ++;\r\n                    }\r\n                ");

                }
      out.write("\r\n                if(j == 0){\r\n                    document.all.include_comment.value = document.all.");
      out.print(curCommFieldArr[0]);
      out.write(".value;\r\n                    document.all.include_commField.value = \"");
      out.print(curCommFieldArr[0]);
      out.write("\";\r\n                }else if(j == 1){\r\n                    commentValue = commentValue.substring(3, commentValue.length-3);\r\n                    document.all.include_comment.value = commentValue.substring(commentValue.indexOf(\";;;\") + 3, commentValue.length);\r\n                    document.all.include_commField.value = commFieldValue.substring(1, commFieldValue.length-1);\r\n                }else{\r\n                    document.all.include_comment.value = commentValue;\r\n                    document.all.include_commField.value = commFieldValue;\r\n                }\r\n                ");

            }
    	}else{
        
      out.write("\r\n\t\t\tif(document.all.comment){\r\n\t\t\t\tvar commentSignType = document.all.commentSignType.value;\r\n\t\t\t\tif(document.all.comment.length){\r\n\t\t\t\t\tdocument.all.include_comment.value = document.all.comment[commentSignType].value;\r\n\t\t\t\t} else{\r\n\t\t\t\t\tdocument.all.include_comment.value = document.all.comment.value;\r\n\t\t\t\t}\r\n            }\r\n        ");

        }
    }
    
      out.write("\r\n}\r\n\r\nfunction include_randomSave(s){\r\n    if(s == \"next\"){\r\n        if(document.all.randomProcUser){\r\n            if(document.all.randomProcUser.value == \"\"){\r\n                alert(\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeseldealuser"));
      out.write("\");\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    if(");
      out.print(saveCheckFn);
      out.write("){\r\n        if(!include_saveSignature()){            \r\n            return;\r\n        }\r\n        include_setComment();\r\n        ");
      out.print(formName);
      out.write(".target = \"include_iframe\";\r\n        ");
      out.print(formName);
      out.write(".action = \"/jsoa/WorkflowCommonAction.do?flag=random&type=\" + s;\r\n        ");
      out.print(formName);
      out.write(".submit();\r\n\t\tif(s == \"next\"){\r\n\t\t\talert(\"已成功提交给\"+document.all.randomProcUserName.value+\"！\");\r\n\t\t} else{\r\n\t\t\talert(\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeprocesshascomplete"));
      out.write("\");\r\n\t\t}\r\n    }\r\n}\r\n\r\nfunction include_myOpen(obj, objName, rangeName, rangeId){\r\n    var imgObj = eval(\"document.all.\" + objName);\r\n    if(imgObj.length){\r\n        for(var i = 0; i < imgObj.length; i ++){\r\n            if(imgObj[i] == obj){\r\n                var input_name = eval(\"document.all.\" + rangeName + \"[\" + i + \"]\");\r\n                var input_id = eval(\"document.all.\" + rangeId + \"[\" + i + \"]\");\r\n                openEndow(rangeId + \"[\" + i + \"]\",rangeName + \"[\" + i + \"]\", input_id.value, input_name.value, \"user\",\"no\",\"orgusergroup\",\"*0*\");\r\n                break;\r\n            }\r\n        }\r\n    }else{\r\n        if(obj == imgObj){\r\n            var input_name = eval(\"document.all.\" + rangeName);\r\n            var input_id = eval(\"document.all.\" + rangeId);\r\n            openEndow(rangeId,rangeName,input_id.value,input_name.value,\"user\",\"no\",\"orgusergroup\",\"*0*\");\r\n        }\r\n    }\r\n}\r\n\r\n\r\n//选择全部办理/阅件用户\r\nfunction selectAll(name,obj){\r\n\tif(eval(\"document.all.\"+name)){\r\n\t\tif(eval(\"document.all.\"+name+\".length\")){\r\n");
      out.write("\t\t\tfor(i=0;i<eval(\"document.all.\"+name+\".length\");i++){\r\n\t\t\t\tif(obj.checked){\r\n\t\t\t\t\teval(\"document.all.\"+name)[i].checked = true;\r\n\t\t\t\t}else{\r\n\t\t\t\t\teval(\"document.all.\"+name)[i].checked = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\tif(obj.checked){\r\n\t\t\t\teval(\"document.all.\"+name).checked = true;\r\n\t\t\t}else{\r\n\t\t\t\teval(\"document.all.\"+name).checked = false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\nfunction cmdClose(){\r\n\tvar backto = document.getElementById(\"backto\").value;\r\n    include_close(backto);\r\n}\r\n\r\n//关闭\r\nfunction include_close(backto){\r\n\t// 解除对表单的占用\r\n    sendRequest(\"");
      out.print(recordId);
      out.write('"');
      out.write(',');
      out.write('"');
      out.print(tableId);
      out.write('"');
      out.write(',');
      out.write('"');
      out.print(processId);
      out.write('"');
      out.write(',');
      out.write('"');
      out.print(workId);
      out.write("\");\r\n    backto = document.getElementById(\"backto\").value;\r\n   \t// 页面跳转\r\n   \tif(\"dbsx\" == backto){\t// 待办事项\r\n    \tlocation.replace(\"/jsoa/weiXinBacklogAction.do?action=list&status=0\");\r\n    } else if(\"dysx\" == backto){\t// 待阅事项\r\n    \tlocation.replace(\"/jsoa/weiXinBacklogAction.do?action=list&status=2\");\r\n    } else if(\"ybsx\" == backto){\t// 已办事项\r\n    \tlocation.replace(\"/jsoa/weiXinBacklogAction.do?action=list&status=101&from=mine\");\r\n    } else if(\"yysx\" == backto){\t// 已阅事项\r\n    \tlocation.replace(\"/jsoa/weiXinBacklogAction.do?action=list&status=102&from=mine\");\r\n    } else if(\"yfzb\" == backto){\t// 已发在办\r\n    \tlocation.replace(\"/jsoa/weiXinBacklogAction.do?action=mine&workStatus=1\");\r\n    } else if(\"yfbj\" == backto){\t// 已发办结\r\n    \tlocation.replace(\"/jsoa/weiXinBacklogAction.do?action=mine&workStatus=100\");\r\n    } else if(\"yfth\" == backto){\t// 已发退回\r\n    \tlocation.replace(\"/jsoa/weiXinBacklogAction.do?action=mine&workStatus=-1\");\r\n    } else if(\"yfqx\" == backto){\t// 已发取消\r\n    \tlocation.replace(\"/jsoa/weiXinBacklogAction.do?action=mine&workStatus=-2\");\r\n");
      out.write("    } else if(\"cbtx\" == backto){\t// 已发取消\r\n    \tlocation.replace(\"/jsoa/weiXinMessageAction.do?method=personalCuibanList&from=1\");\r\n    } else{\t// 否则认为是消息提醒过来的，关闭窗口\r\n    \t");

		if("weixin".equals(loginType)){
			
      out.write("closeWindow();");

		} else if("wap".equals(loginType)){
			
      out.write("loadURL();");

		}
		
      out.write("\r\n\t}\r\n}\r\n\r\n//在线锁提醒\r\nfunction checkWFOnlineUser(){\r\n\t\r\n\tvar nolock = false;\r\n\tfunction alertOnlineUser(s){\r\n\t\tif(s != \"\"){\r\n\t\t\tweixinMessageReminder(\"alert\", \"提示：\", s+\"");
      out.print(Resource.getValue(localhi,"workflow","workflow.includeediting"));
      out.write("\", \"\");\r\n\t\t\tnolock = false;\r\n\t\t} else{\r\n\t\t\tnolock = true;\r\n\t\t}\r\n\t\t\r\n\t}\r\n\t DWREngine.setAsync(false);       //设置成同步 \r\n\t workflowSync.getWFOnlineUser(document.all.recordId.value, document.all.tableId.value, document.all.processId.value, document.all.workId.value,'");
      out.print(session.getAttribute("userAccount").toString());
      out.write('\'');
      out.write(',');
      out.write('\'');
      out.print(pageKey);
      out.write("', alertOnlineUser);\r\n\t DWREngine.setAsync(true);       //重新设置为异步方式\r\n\t\r\n\t \r\n\t return nolock;    \r\n\r\n}\r\n</script>\r\n<iframe id=\"include_iframe\" name=\"include_iframe\" style=\"display:none\"></iframe>\r\n");
}
      out.write('\r');
      out.write('\n');

if("y".equals(request.getParameter("fromDossierData")) && "100".equals(request.getParameter("workStatus"))&&
		request.getParameter("finish")==null){
	operButton+=",FlowToArchives";
}

      out.write("\r\n\r\n<!--流程按钮-->\r\n<script src=\"/jsoa/weixin/public/cmdbuttonForWeiXin.jsp?button=Close");
      out.print(operButton);
      out.write("\"></script> \r\n<!--流程按钮-->\r\n\r\n\r\n");

//显示办理提示
String dealTips = new com.js.oa.jsflow.service.WorkFlowButtonBD().getDealTipsByWorkId(request.getParameter("work"));

      out.write("\r\n<SCRIPT LANGUAGE=\"JavaScript\">\r\nfunction showDealTips(){\r\n\t");
if(dealTips!=null && !dealTips.equals("")){
      out.write("\t\t\r\n\t\t//JSMainWinOpenNew(\"/jsoa/weixin/workflow/showDealTipsForWeiXin.jsp?work=");
      out.print(request.getParameter("work"));
      out.write("\",'','scrollbars=yes,resizable=yes,width=250,height=150');\r\n\t");
}
      out.write("\r\n}\r\n\r\nvar i_link,i_handle,i_para;\r\nfunction createSubProcess(link,handle,para){\r\n\ti_link=link;\r\n\ti_handle=handle;\r\n\ti_para=para;\r\n\tvar subProcWorkId=document.getElementsByName(\"subProcWorkId\")[0].value;\t\r\n\tvar processId=document.getElementsByName(\"subProcId\")[0].value;\r\n\tif(subProcWorkId==\"\"){\r\n\t    //JSMainWinOpen(link,hand,para);\r\n\t    workflowSync.userCanCreateFlow(processId,'");
      out.print(session.getAttribute("userId").toString());
      out.write("', '");
      out.print(session.getAttribute("orgId").toString());
      out.write("', '");
      out.print(session.getAttribute("orgIdString").toString());
      out.write("', getCreateSubProcessRight);\r\n\t}else{\r\n\t\tif(weixinMessageReminder(\"confirm\", \"提示：\", \"当前流程已经发起过子流程,您确定还要再次发起吗?\", \"\")){\r\n\t\t\t//JSMainWinOpen(link,hand,para);\r\n\t\t\tworkflowSync.userCanCreateFlow(processId,'");
      out.print(session.getAttribute("userId").toString());
      out.write("', '");
      out.print(session.getAttribute("orgId").toString());
      out.write("', '");
      out.print(session.getAttribute("orgIdString").toString());
      out.write("', getCreateSubProcessRight);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction getCreateSubProcessRight(res){\r\n\t if(res==\"0\"){\r\n\t \tweixinMessageReminder(\"alert\", \"提示：\", \"您没有发起当前子流程的权限,请与管理员联系!\", \"\");\r\n\t }else{\r\n\t \twindow.location.href=i_link;\r\n\t }\r\n}\r\nfunction editOffices(field,fileType,template,showSign){\r\n\tvar recordId = eval(\"document.all.\"+field+\".value\");\r\n\tvar userName = document.all.user_Name.value;\r\n\t");
if(onlineUserValidate){ 
      out.write("\r\n\twindow.open(\"/jsoa/iWebOfficeSign/DocumentEdit.jsp?RecordID=\"+recordId+\"&EditType=0&UserName=\"+userName+\r\n\t\t\t\"&ShowSign=\"+showSign+\"&CanSave=0&moduleType=information&saveHtmlImage=0&saveDocFile=0&field=\"+field+\r\n\t\t\t\"&FileType=.\"+fileType+\"&showEditButton=1&showSignButton=1&Template=\"+template, \r\n\t\t\t\"\", \"status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,Height=400,left=0,top=0\");\r\n\t");
}else{ 
      out.write("\r\n\twindow.open(\"/jsoa/iWebOfficeSign/DocumentEdit.jsp?RecordID=\"+recordId+\"&EditType=1&UserName=\"+userName+\r\n\t\t\t\"&ShowSign=\"+showSign+\"&CanSave=1&moduleType=information&saveHtmlImage=0&saveDocFile=0&field=\"+field+\r\n\t\t\t\"&FileType=.\"+fileType+\"&showEditButton=1&showSignButton=1&Template=\"+template, \r\n\t\t\t\"\", \"status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,Height=400,left=0,top=0\");\r\n\t");
} 
      out.write("\r\n}\r\n</SCRIPT>");
    } catch (java.lang.Throwable t) {
      if (!(t instanceof javax.servlet.jsp.SkipPageException)){
        out = _jspx_out;
        if (out != null && out.getBufferSize() != 0)
          try {
            if (response.isCommitted()) {
              out.flush();
            } else {
              out.clearBuffer();
            }
          } catch (java.io.IOException e) {}
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
        else throw new ServletException(t);
      }
    } finally {
      _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
